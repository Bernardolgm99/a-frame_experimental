AFRAME.registerComponent("portal",{schema:{destination:{default:""},width:{default:2},height:{default:3},maxRecursion:{default:0},teleportCooldown:{default:100},enableTeleport:{default:!0}},init:function(){var e=this.el,t=e.sceneEl,n=this.data;e.justTeleported=!1,e.isCameraColliding=!1;var o=new THREE.BoxBufferGeometry(n.width,n.height,1e-4),a=new THREE.MeshBasicMaterial({colorWrite:!1}),r=new THREE.Mesh(o,a);if(r.name="portal-surface",e.object3D.add(r),t.addEventListener("portal-teleported",function(){e.justTeleported=!0}),e.addEventListener("camera-collision-start",function(){if(0!=n.enableTeleport&&!0!==e.justTeleported){e.justTeleported=!0,t.emit("portal-teleported");var o=t.camera,a=o.el,r=document.querySelector(n.destination).object3D,i=e.object3D.rotation,l=r.rotation,s=new THREE.Euler(i.x-l.x,i.y-l.y+Math.PI,i.z-l.z);a.components["look-controls"]&&(a.components["look-controls"].yawObject.rotation.y-=s.y);var c=e.object3D.getWorldDirection(new THREE.Vector3).multiplyScalar(.075),d=o.getWorldPosition(new THREE.Vector3),u=e.object3D.getWorldPosition(new THREE.Vector3),E=(new THREE.Vector3).subVectors(d,u).sub(c),m=E.clone(),p=s.y;m.x=E.x*Math.cos(p)-E.z*Math.sin(p),m.z=E.x*Math.sin(p)+E.z*Math.cos(p);var x=r.position.clone().add(m);a.object3D.position.x=x.x,a.object3D.position.y=x.y,a.object3D.position.z=x.z}}),t.portals||(t.portals=[]),!1===Array.from(t.children).reduce(function(e,t){return e||t.hasAttribute("portal-manager")},!1)){var i=document.createElement("a-entity");i.setAttribute("portal-manager",{maxRecursion:n.maxRecursion}),t.appendChild(i)}var l=t.portals,s=document.querySelector(n.destination);l.push({portal:e.object3D,destination:s.object3D,maxRecursion:n.maxRecursion,distance:0})},tick:function(){var e=this.el;!0===e.justTeleported&&setTimeout(function(){e.justTeleported=!1},this.data.teleportCooldown)}}),AFRAME.registerComponent("portal-manager",{schema:{skipTicks:{default:25},maxRecursion:{default:0}},init:function(){var e=this.data,t=this.el.sceneEl;e.ticks=0,e.maxRecursion=t.portals.reduce(function(e,t){return Math.max(e,t.maxRecursion)},e.maxRecursion)},tick:function(){var e=this.data,t=this.el.sceneEl,n=t.portals;if(e.ticks%e.skipTicks==0){var o=t.camera.getWorldPosition(new THREE.Vector3);n.forEach(function(e){e.distance=e.portal.getWorldPosition(new THREE.Vector3).distanceTo(o)}),n.sort(function(e,t){return t.distance-e.distance})}e.ticks++},tock:function(){var e=this.el.sceneEl;this.renderRecursivePortals(e.renderer,e.camera,0),this.collisionDetection()},renderRecursivePortals:function(e,t,n){var o=this,a=this.el.sceneEl,r=a.portals,i=e.getContext(),l=a.object3D.clone();e.autoClear=!1,t.matrixAutoUpdate=!1,r.forEach(function(a){var r=a.portal,s=a.destination;i.colorMask(!1,!1,!1,!1),i.depthMask(!1),i.disable(i.DEPTH_TEST),i.enable(i.STENCIL_TEST),i.stencilFunc(i.NOTEQUAL,n,255),i.stencilOp(i.INCR,i.KEEP,i.KEEP),i.stencilMask(255),e.render(r,t);var c=t.clone();c.matrixWorld=function(e,t,n){var o=e.matrixWorld.clone();o.invert().multiply(t.matrixWorld);var a=n.matrixWorld.clone().invert(),r=(new THREE.Matrix4).makeRotationY(Math.PI);return(new THREE.Matrix4).multiply(o).multiply(r).multiply(a).invert()}(t,r,s),c.projectionMatrix=function(e,t,n){var o=t.clone().invert(),a=(new THREE.Matrix4).extractRotation(e.matrixWorld),r=(new THREE.Vector3).set(0,0,1).applyMatrix4(a),i=new THREE.Plane;i.setFromNormalAndCoplanarPoint(r,e.getWorldPosition(new THREE.Vector3)),i.applyMatrix4(o);var l=new THREE.Vector4;l.set(i.normal.x,i.normal.y,i.normal.z,i.constant);var s=n.clone(),c=new THREE.Vector4;return c.x=(Math.sign(l.x)+s.elements[8])/s.elements[0],c.y=(Math.sign(l.y)+s.elements[9])/s.elements[5],c.z=-1,c.w=(1+s.elements[10])/n.elements[14],l.multiplyScalar(2/l.dot(c)),s.elements[2]=l.x,s.elements[6]=l.y,s.elements[10]=l.z+1,s.elements[14]=l.w,s}(s,c.matrixWorld,c.projectionMatrix),n==o.data.maxRecursion?(i.colorMask(!0,!0,!0,!0),i.depthMask(!0),e.clear(!1,!0,!1),i.enable(i.DEPTH_TEST),i.enable(i.STENCIL_TEST),i.stencilMask(0),i.stencilFunc(i.EQUAL,n+1,255),e.render(l,c)):o.renderRecursivePortals(e,c,n+1),i.colorMask(!1,!1,!1,!1),i.depthMask(!1),i.enable(i.STENCIL_TEST),i.stencilMask(255),i.stencilFunc(i.NOTEQUAL,n+1,255),i.stencilOp(i.DECR,i.KEEP,i.KEEP),e.render(r,t)}),i.disable(i.STENCIL_TEST),i.stencilMask(0),i.colorMask(!1,!1,!1,!1),i.enable(i.DEPTH_TEST),i.depthMask(!0),i.depthFunc(i.ALWAYS),e.clear(!1,!0,!1),r.forEach(function(n){e.render(n.portal,t)}),i.depthFunc(i.LESS),i.enable(i.STENCIL_TEST),i.stencilMask(0),i.stencilFunc(i.LEQUAL,n,255),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),e.render(l,t),t.matrixAutoUpdate=!0},collisionDetection:function(){var e=this.el.sceneEl,t=e.camera,n=e.portals.map(function(e){var t=e.portal,n=t.children.filter(function(e){return"portal-surface"==e.name})[0],o=(new THREE.Box3).setFromObject(n);return{portal:t,xMin:o.min.x,xMax:o.max.x,yMin:o.min.y,yMax:o.max.y,zMin:o.min.z,zMax:o.max.z}}),o=t.getWorldPosition(new THREE.Vector3),a=o.x-.05,r=o.x+.05,i=o.y-.05,l=o.y+.05,s=o.z-.05,c=o.z+.05;n.forEach(function(e){if(a<=e.xMax&&r>=e.xMin&&i<=e.yMax&&l>=e.yMin&&s<=e.zMax&&c>=e.zMin){var t=e.portal.el;!1===t.isCameraColliding&&(t.emit("camera-collision-start"),t.isCameraColliding=!0)}else{var n=e.portal.el;!0===n.isCameraColliding&&(n.emit("camera-collision-end"),n.isCameraColliding=!1)}})}});
//# sourceMappingURL=aframe-portals.js.map
